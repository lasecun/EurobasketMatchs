name: ğŸ§ª Test Suite - Comprehensive Testing

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests every day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  # ============================================================================
  # JOB 1: UNIT TESTS
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: ğŸ”¥ Setup Firebase Configuration
      env:
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
      run: |
        echo "=== Firebase Configuration Setup ==="
        if [ -z "$GOOGLE_SERVICES_JSON" ]; then
          echo "âŒ ERROR: GOOGLE_SERVICES_JSON secret is not set!"
          exit 1
        fi
        echo "âœ… Secret is available (length: ${#GOOGLE_SERVICES_JSON})"
        mkdir -p app
        echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
        mkdir -p app/src
        echo "$GOOGLE_SERVICES_JSON" > app/src/google-services.json
        if [ -f app/google-services.json ] && [ -s app/google-services.json ]; then
          echo "âœ… File created successfully"
          echo "ğŸ“ Location: $(pwd)/app/google-services.json"
          echo "ğŸ“ Size: $(wc -c < app/google-services.json) bytes"
          ls -la app/google-services.json
        else
          echo "âŒ ERROR: File creation failed!"
          exit 1
        fi

    - name: ï¿½ğŸ”§ Make gradlew executable
      run: chmod +x ./gradlew

    - name: ğŸ“¦ Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}

    - name: ğŸ§ª Run Unit Tests
      run: ./gradlew testDebugUnitTest --continue --parallel

    - name: ğŸ“¤ Upload Unit Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-${{ github.sha }}
        path: |
          app/build/reports/tests/testDebugUnitTest/
          app/build/test-results/testDebugUnitTest/
          app/build/test-results/testDebugUnitTest/
        retention-days: 5

  # ============================================================================
  # JOB 2: TEST QUALITY METRICS
  # ============================================================================
  test-quality:
    name: ğŸ¯ Test Quality Metrics
    runs-on: ubuntu-latest
    needs: [unit-tests]
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: ğŸ”§ Make gradlew executable
      run: chmod +x ./gradlew

    - name: ğŸ“Š Generate Test Metrics
      run: |
        ./gradlew testDebugUnitTest --continue
        echo "## ğŸ¯ Test Quality Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count test files
        TEST_FILES=$(find app/src/test -name "*.kt" | wc -l)
        echo "ğŸ“ **Test Files:** $TEST_FILES" >> $GITHUB_STEP_SUMMARY
        
        # Count test methods (approximation)
        TEST_METHODS=$(grep -r "@Test" app/src/test --include="*.kt" | wc -l)
        echo "ğŸ§ª **Test Methods:** $TEST_METHODS" >> $GITHUB_STEP_SUMMARY
        
        # Test execution summary
        if [ -f app/build/test-results/testDebugUnitTest/TEST-*.xml ]; then
          echo "âœ… **Unit Tests:** Executed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Unit Tests:** Execution failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Test Categories Covered" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Data Mappers (PlayerMapper, MatchMapper, etc.)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Repository Pattern (TeamRosterRepository)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ViewModels (TeamRosterViewModel, MainViewModel)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Navigation (PlayerNavigationHelper)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Utilities (PlayerImageUtil)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 5: TEST RESULTS SUMMARY
  # ============================================================================
  test-summary:
    name: ğŸ“‹ Test Results Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, test-quality]
    if: always()
    
    steps:
    - name: ğŸ“Š Final Test Summary
      run: |
        echo "## ğŸ§ª Complete Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Job Results Overview" >> $GITHUB_STEP_SUMMARY
        echo "| Test Category | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª Unit Tests | ${{ needs.unit-tests.result }} | All unit tests executed |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ¯ Test Quality | ${{ needs.test-quality.result }} | Test quality metrics |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ† Test Coverage Highlights" >> $GITHUB_STEP_SUMMARY
        echo "- **105+ Unit Tests** across multiple components" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Layer Coverage:** Repository pattern, mappers, entities" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain Layer Coverage:** Business logic and models" >> $GITHUB_STEP_SUMMARY
        echo "- **Presentation Layer Coverage:** ViewModels and navigation" >> $GITHUB_STEP_SUMMARY
        echo "- **Utils Coverage:** Image handling, data processing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Test Run Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
